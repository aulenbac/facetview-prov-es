<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>PROV-ES Facet Search</title>

  <script type="text/javascript" src="{{ url_for('static', filename='facetview/vendor/jquery/1.7.2/jquery-1.7.2.min.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='jquery-validation-1.12.0/dist/jquery.validate.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='jquery-validation-1.12.0/lib/jquery.form.js') }}"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='facetview/vendor/bootstrap-2.3.2/css/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='facetview/vendor/bootstrap-2.3.2/css/bootstrap-responsive.min.css') }}">
  <script type="text/javascript" src="{{ url_for('static', filename='facetview/vendor/bootstrap-2.3.2/js/bootstrap.min.js') }}"></script>  

  <script type="text/javascript" src="{{ url_for('static', filename='facetview/vendor/linkify/1.0/jquery.linkify-1.0-min.js') }}"></script>  
  
  <link rel="stylesheet" href="{{ url_for('static', filename='facetview/vendor/jquery-ui-1.8.18.custom/jquery-ui-1.8.18.custom.css') }}">
  <script type="text/javascript" src="{{ url_for('static', filename='facetview/vendor/jquery-ui-1.8.18.custom/jquery-ui-1.8.18.custom.min.js') }}"></script>

  <script type="text/javascript" src="{{ url_for('static', filename='facetview/jquery.facetview.js') }}"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='facetview/css/facetview.css') }}">

  <link rel="stylesheet" href="{{ url_for('static', filename='facetview/css/style.css') }}">

  <link rel="stylesheet" href="{{ url_for('static', filename='facetview/vendor/jqzoom_ev-2.3/css/jquery.jqzoom.css') }}">
  <script type="text/javascript" src="{{ url_for('static', filename='facetview/vendor/jqzoom_ev-2.3/js/jquery.jqzoom-core.js') }}"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='facetview/vendor/leaflet-0.6.2/leaflet.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='facetview/vendor/Leaflet.draw/dist/leaflet.draw.css') }}">
  <!--[if lte IE 8]>
    <link rel="stylesheet" href="{{ url_for('static', filename='facetview/vendor/leaflet-0.6.2/leaflet.ie.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='facetview/vendor/Leaflet.draw/dist/leaflet.draw.ie.css') }}" />
  <![endif]-->

  <script type="text/javascript" src="{{ url_for('static', filename='facetview/vendor/leaflet-0.6.2/leaflet.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='facetview/vendor/Leaflet.draw/dist/leaflet.draw.js') }}"></script>

  <!-- 
  <link href="{{ url_for('static', filename='facetview/vendor/jQRangeSlider-5.5.0/css/iThing.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='facetview/vendor/jQRangeSlider-5.5.0/jQAllRangeSliders-withRuler-min.js') }}"></script>
  -->

  <script src="{{ url_for('static', filename='JSON-js/json2.js') }}"></script>

  <link href="{{ url_for('static', filename='facetview/vendor/bootstrap-tags/bootstrap-tags.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='facetview/vendor/bootstrap-tags/bootstrap-tags.js') }}"></script>

  <link href="{{ url_for('static', filename='tablecloth-1.0.0/assets/css/tablecloth.css' ) }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='tablecloth-1.0.0/assets/css/prettify.css' ) }}" rel="stylesheet"> 
  <script src="{{ url_for('static', filename='tablecloth-1.0.0/assets/js/jquery.metadata.js' ) }}"></script>
  <script src="{{ url_for('static', filename='tablecloth-1.0.0/assets/js/jquery.tablesorter.min.js' ) }}"></script>
  <script src="{{ url_for('static', filename='tablecloth-1.0.0/assets/js/jquery.tablecloth.js' ) }}"></script>

  <script src="{{ url_for('static', filename='jquery-tagcloud-0.5.0/jquery.tagcloud.js' ) }}"></script>

  <script type="text/javascript" src="{{ url_for('static', filename='d3-3.5.5/d3.min.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='d3-tip-0.6.3/d3.tip.v0.6.3.js') }}"></script>
  <script type="text/javascript" src="{{ url_for('static', filename='prov-es-fdl/prov-es-fdl-facetview.js') }}"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='prov-es-fdl/prov-es-fdl-facetview.css') }}">


  <style>
    .location_search_map {
      width: 100%;
      height: 400px;
    }

    .map {
      width: 250px;
      height: 250px;
    }

    .btn {
      vertical-align: top;
    }

    .modal {
      width: 90%;
      max-width: 1024px;
      margin-left:auto;
      margin-right:auto;
    }

    .modal .modal-header {
      height: 10%;
    }

    .modal-body {
      height: 90%;
    }

    .modal-body-div {
      height: 100%;
      overflow-y: auto;
      width: 100%;
    }

    /* jquery validation */
    label.valid {
      width: 24px;
      height: 24px;
      background: url({{ url_for('static', filename='img/valid.png') }}) center center no-repeat;
      display: inline-block;
      text-indent: -9999px;
    }

    label.error {
      font-weight: bold;
      color: red;
      padding: 2px 8px;
      margin-top: 2px;
    }

    /* loading backdrop */
    .loading-backdrop {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
      z-index: 1040;
      background-color: #000000;
    }

    .loading-backdrop.fade {
      opacity: 0;
    }

    .loading-backdrop, .loading-backdrop.fade.in {
      opacity: 0.3;
      filter: alpha(opacity=30);
    }

  </style>

  <script type="text/javascript">

function jq( myid ) {
  return "#" + myid.replace( /(:|\.|\[|\])/g, "\\$1" );
}

function set_left_margin() {
  return ($(window).width() - $(this).width())/2;
}

function show_prov_es_json() {
  var id = this.id.split("_")[1];
  $('#prov_es_json_modal_download').attr('disabled', true);
  $('#prov_es_json_modal_download').attr('href', "{{ url_for('api_v0-1.download_prov_es_json') }}?id=" + id);
  //console.log(id);
  $.ajax({
    url: "{{ url_for('api_v0-1.prov_es_json') }}",
    data: { id: id },
    success: function(data, sts, xhr) {
      //console.log(data);
      var json_str = JSON.stringify(data['result']['prov_es_json'], null, '  ');
      $('#prov_es_json_text').html('<pre>' + json_str + '</pre>');
      $('#prov_es_json_modal').modal('show').css({'left': set_left_margin});
    },
    error: function(xhr, sts, err) {
      //console.log(xhr);
      $('#general_error').html("Error: " + xhr.responseText);
      $('#error_modal').modal('show').css({'left': set_left_margin});
    }
  });
}

function show_prov_es_ttl() {
  var id = this.id.split("_")[1];
  $('#prov_es_ttl_modal_download').attr('disabled', true);
  $('#prov_es_ttl_modal_download').attr('href', "{{ url_for('api_v0-1.download_prov_es_ttl') }}?id=" + id);
  //console.log(id);
  $.ajax({
    url: "{{ url_for('api_v0-1.prov_es_ttl') }}",
    data: { id: id },
    success: function(data, sts, xhr) {
      console.log(data);
      var ttl = data['result'].replace(/</g, '&lt;').replace(/>/g, '&gt;');
      $('#prov_es_ttl_text').html('<pre>' + ttl + '</pre>');
      $('#prov_es_ttl_modal').modal('show').css({'left': set_left_margin});
    },
    error: function(xhr, sts, err) {
      //console.log(xhr);
      $('#general_error').html("Error: " + xhr.responseText);
      $('#error_modal').modal('show').css({'left': set_left_margin});
    }
  });
}


// global backdrop
var backdrop = null;


jQuery(document).ready(function($) {
  Tags.bootstrapVersion = "2";

  $('.facet-view-simple').facetview({
    search_url: "{{ url_for('api_v0-1.query') }}?",
    search_index: 'elasticsearch',
    facets: [
        {'field':'_type', 'display': 'concept'},
        {'field':'prov:type.raw', 'display': 'prov:type'},
        {'field':'prov:entity.raw', 'display': 'prov:entity'},
        {'field':'prov:activity.raw', 'display': 'prov:activity'},
        {'field':'prov:agent.raw', 'display': 'prov:agent'},
        {'field':'prov:startTime', 'display': 'prov:startTime', 'type': 'date'},
        {'field':'prov:endTime', 'display': 'prov:endTime', 'type': 'date'},
        {'field':'prov:collection.raw', 'display': 'prov:collection'},
        {'field':'gcis:sourceInstrument.raw', 'display': 'gcis:sourceInstrument'},
        {'field':'eos:level.raw', 'display': 'eos:level'},
        {'field':'eos:version.raw', 'display': 'eos:version'},
        {'field':'eos:usesSoftware.raw', 'display': 'eos:usesSoftware'},
        {'field':'gcis:hasInstrument.raw', 'display': 'gcis:hasInstrument'},
        {'field':'gcis:inPlatform.raw', 'display': 'gcis:inPlatform'},
        {'field':'gcis:hasSensor.raw', 'display': 'gcis:hasSensor'},
        {'field':'gcis:hasGoverningOrganization.raw', 'display': 'gcis:hasGoverningOrganization'},
        {'field':'gcis:inInstrument.raw', 'display': 'gcis:inInstrument'},
        {'field':'gcis:implements.raw', 'display': 'gcis:implements'},
        {'field':'gcis:implementedIn.raw', 'display': 'gcis:implementedIn'},
        {'field':'gcis:describedBy.raw', 'display': 'gcis:describedBy'},
        {'field':'eos:usesSoftware.raw', 'display': 'eos:usesSoftware'},
        //{'field':'hysds:host.raw', 'display': 'hysds:host'},
        {'field':'eos:hasRuntimeParameter.raw', 'display': 'eos:hasRuntimeParameter'}
    ],
    time_fields: [
        'prov:startTime',
        'prov:endTime'
    ],
//    location_field: 'location',
    json_fields: [
        'prov:used',
        'prov:generated',
        'prov:type'
    ],
    filterchoice_result_fields: {
        //'_id': '_id'
    },
    enable_rangeselect: true,
    enable_locationselect: false,
    paging: {
      from: 0,
      size: 10
    },
    pager_on_top: true,
    sort: [{ '_timestamp': { "order": "desc"} }],
    fields: [ '_id', '_timestamp', '_source'],
    display_images: false,
    pre_search_callback: function() {
      if (backdrop === null) {
        // fade the backdrop in
        var animate = 'fade';
        var doAnimate = $.support.transition && animate;
        backdrop = $('<div class="loading-backdrop ' + animate + '" />').appendTo(document.body);
        if (doAnimate) backdrop[0].offsetWidth;
        backdrop.addClass('in');
        if (doAnimate) backdrop.one($.support.transition.end, function() {});
      }
    },
    post_search_callback: function() {
      // remove the backdrop
      $(".loading-backdrop").remove();
      backdrop = null;
    },
    word_cloud: false,
    result_display: [
      [
        {
          "pre": "<strong id='concept_",
          "field": "_id",
          "post": "'></strong><script>$(function() {\n" +
                  "  var concept = null;\n" +
                  "  var prov_type = null;\n"
        },
        {
          "pre": "  concept = '",
          "field": "_type",
          "post": "';\n"
        },
        {
          "pre": "  prov_type = '",
          "field": "prov:type",
          "post": "';\n"
        },
        {
          "pre": "  var id='",
          "field": "_id",
          "post": "';\n" +
                 "  var strong = $(jq('concept_' + id));\n" +
                  "  if (prov_type !== null) {\n" +
                  "    if (prov_type[0] == '{') {\n" +
                  "      prov_type = JSON.parse(prov_type)['$'];\n" +
                  "    }\n" +
                  "    strong.text('(' + concept + ' - ' + prov_type + ') ');\n" +
                  "  }else {\n" +
                  "    strong.text('(' + concept + ') ');\n" +
                  "  }\n" +
                  "});\n" +
                  "<\/script>"
        },
        {
          "pre": "<strong id='header_",
          "field": "_id",
          "post": "'></strong><script>$(function() {\n" +
                  "  var title = null;\n"
        },
        {
          "pre": "  title = '",
          "field": "dcterms:title",
          "post": "';\n"
        },
        {
          "pre": "  var id='",
          "field": "_id",
          "post": "';\n" +
                 "  var strong = $(jq('header_' + id));\n" +
                  "  if (title !== null) {\n" +
                  "    strong.text(title);\n" +
                  "  }else {\n" +
                  "    strong.text(id);\n" +
                  "  }\n" +
                  "});\n" +
                  "<\/script>"
        }
      ],
/*
      [
        {
          "pre": "<table><tr><td><div id='img_grid_",
          "field": "_id",
          "post": "'></div><script>$(function() {\n" +
                  "  var imgData = [];\n"
        },
        {
          "pre": "  imgData = ",
          "field": "href_metadata.files",
          "post": ";\n"
        },
        {
          "pre": "  var id='",
          "field": "_id",
          "post": "';\n" +
                  "  if (imgData.length > 0) {\n" +
                  "    var grid =  $('div[id=\"img_grid_' + id + '\"]');\n" +
                  "    grid.append('<table><tr>');\n" +
                  "    for (var i=0; i<imgData.length; i++) {\n" +
                  "      var img_url = imgData[i].href;\n" +
                  "      var small_img_url = imgData[i].href;\n" +
                  "      var tooltip = '';\n" +
                  "      if (typeof imgData[i].tooltip == 'string' || imgData[i].tooltip instanceof String) {\n" +
                  "        if (imgData[i].tooltip.length > 0) \n" +
                  "          tooltip = '<span class=\"label label-info\">' + imgData[i].tooltip + '</span>';\n" +
                  "      }\n" +
                  "      grid.append('<td>' + tooltip + '<a target=\"_blank\" href=\"' + img_url + '\">" +
                  "  <img src=\"' + small_img_url + '\" class=\"img-rounded\" width=\"250px\" " +
                  "height=\"250px\" /></a></td>');\n" +
                  "      if (i % 3 == 2) grid.append('</tr><tr>');\n" +
                  "    }\n" +
                  "    grid.append('<td><span class=\"label label-info\">region</span><div id=\"map_' + id + '\" class=\"map\"></div></td></tr></table>');\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
*/
      [
        {
          "pre": "id: <font color='blue'>",
          "field": "_id",
          "post": "</font>"
        }
      ],
      [
        {
          "pre": "<span id='prov_type_",
          "field": "_id",
          "post": "'></span><script>$(function() {\n" +
                  "  var prov_type = null;\n"
        },
        {
          "pre": "  prov_type = '",
          "field": "prov:type",
          "post": "';\n"
        },
        {
          "pre": "  var id='",
          "field": "_id",
          "post": "';\n" +
                 "  var pt_div = $(jq('prov_type_' + id));\n" +
                  "  if (prov_type !== null) {\n" +
                  "    if (prov_type[0] == '{') {\n" +
                  "      prov_type = JSON.parse(prov_type)['$'];\n" +
                  "    }\n" +
                  "    pt_div.html('prov:type: <font color=\\'blue\\'>' + prov_type + '</font>');\n" +
                  "  }else {\n" +
                  "    pt_div.remove();\n" +
                  "  }\n" +
                  "});\n" +
                  "<\/script>"
        }
      ],
      [
        {
          "pre": "prov:concept: <font color='blue'>",
          "field": "prov:concept",
          "post": "</font>"
        }
      ],
      [
        {
          "pre": "hysds:job_id: <font color='blue'>",
          "field": "hysds:job_id",
          "post": "</font>"
        }
      ],
      [
        {
          "pre": "info:doi: <font color='blue'>",
          "field": "info:doi",
          "post": "</font>"
        }
      ],
      [
        {
          "pre": "gcis:accessURL: <font color='blue'>",
          "field": "gcis:accessURL",
          "post": "</font>"
        }
      ],
      [
        {
          "pre": "gcis:downloadURL: <font color='blue'>",
          "field": "gcis:downloadURL",
          "post": "</font>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_sourceInstrument_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "gcis:sourceInstrument: <a>",
          "field": "gcis:sourceInstrument",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var ns_div = $(jq('newsearch_sourceInstrument_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  var link = $(ns_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_level_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "eos:level: <a>",
          "field": "eos:level",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var ns_div = $(jq('newsearch_level_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  var link = $(ns_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_version_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "eos:version: <a>",
          "field": "eos:version",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var ns_div = $(jq('newsearch_version_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  var link = $(ns_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_hasInstrument_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "gcis:hasInstrument: <a>",
          "field": "gcis:hasInstrument",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var ns_div = $(jq('newsearch_hasInstrument_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  var link = $(ns_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_inPlatform_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "gcis:inPlatform: <a>",
          "field": "gcis:inPlatform",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var ns_div = $(jq('newsearch_inPlatform_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  var link = $(ns_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_hasSensor_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "gcis:hasSensor: <a>",
          "field": "gcis:hasSensor",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var ns_div = $(jq('newsearch_hasSensor_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  var link = $(ns_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_hasGoverningOrganization_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "gcis:hasGoverningOrganization: <a>",
          "field": "gcis:hasGoverningOrganization",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var ns_div = $(jq('newsearch_hasGoverningOrganization_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  var link = $(ns_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_inInstrument_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "gcis:inInstrument: <a>",
          "field": "gcis:inInstrument",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var ns_div = $(jq('newsearch_inInstrument_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  var link = $(ns_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_implements_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "gcis:implements: <a>",
          "field": "gcis:implements",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var ns_div = $(jq('newsearch_implements_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  var link = $(ns_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "gcis:implementedIn: <font color='blue'>",
          "field": "gcis:implementedIn",
          "post": "</font>"
        }
      ],
      [
        {
          "pre": "eos:describedBy: <font color='blue'>",
          "field": "eos:describedBy",
          "post": "</font>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_usesSoftware_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "eos:usesSoftware: <a>",
          "field": "eos:usesSoftware",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var ns_div = $(jq('newsearch_usesSoftware_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  var link = $(ns_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_wasAssociatedWith_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "prov:wasAssociatedWith: <a>",
          "field": "prov:wasAssociatedWith",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var ns_div = $(jq('newsearch_wasAssociatedWith_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  var link = $(ns_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_runTimeContext_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "eos:runTimeContext: <a>",
          "field": "eos:runTimeContext",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var ns_div = $(jq('newsearch_runTimeContext_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  var link = $(ns_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_used_",
          "field": "_id",
          "post": "'></div><script>$(function() {\n" +
                  "  var list_data = [];\n"
        },
        {
          "pre": "  list_data = ",
          "field": "prov:used",
          "post": ";\n"
        },
        {
          "pre": "  var id='",
          "field": "_id",
          "post": "';\n" +
                  "  var ns_div = $(jq('newsearch_used_' + id));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  $(ns_div).append('prov:used: ');\n" +
                  "  if (list_data.length > 0) {\n" +
                  "    for (var i=0; i<list_data.length; i++) {\n" +
                  "      var link = $('<a>' + list_data[i] + '</a>');\n" +
                  "      $(ns_div).append(link);\n" +
                  '      link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + list_data[i] + \'\\\\""}}}\');\n' +
                  "      $(ns_div).append('<br/>');\n" +
                  "    }\n" +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_generated_",
          "field": "_id",
          "post": "'></div><script>$(function() {\n" +
                  "  var list_data = [];\n"
        },
        {
          "pre": "  list_data = ",
          "field": "prov:generated",
          "post": ";\n"
        },
        {
          "pre": "  var id='",
          "field": "_id",
          "post": "';\n" +
                  "  var ns_div = $(jq('newsearch_generated_' + id));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  $(ns_div).append('prov:generated: ');\n" +
                  "  if (list_data.length > 0) {\n" +
                  "    for (var i=0; i<list_data.length; i++) {\n" +
                  "      var link = $('<a>' + list_data[i] + '</a>');\n" +
                  "      $(ns_div).append(link);\n" +
                  '      link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + list_data[i] + \'\\\\""}}}\');\n' +
                  "      $(ns_div).append('<br/>');\n" +
                  "    }\n" +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "hysds:pid: <font color='blue'>",
          "field": "hysds:pid",
          "post": "</font>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_host_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "hysds:host: <a>",
          "field": "hysds:host",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var ns_div = $(jq('newsearch_host_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(ns_div).next('br').remove();\n" +
                  "  var link = $(ns_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(ns_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "eos:hasRuntimeParameter: <font color='blue'>",
          "field": "eos:hasRuntimeParameter",
          "post": "</font>"
        }
      ],
      [
        {
          "pre": "prov:time: <font color='blue'>",
          "field": "prov:time",
          "post": "</font>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_activity_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "prov:activity: <a>",
          "field": "prov:activity",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var act_div = $(jq('newsearch_activity_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(act_div).next('br').remove();\n" +
                  "  var link = $(act_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(act_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_entity_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "prov:entity: <a>",
          "field": "prov:entity",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var ent_div = $(jq('newsearch_entity_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(ent_div).next('br').remove();\n" +
                  "  var link = $(ent_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(ent_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<div id='newsearch_collection_",
          "field": "_id",
          "post": "'>"
        },
        {
          "pre": "prov:collection: <a>",
          "field": "prov:collection",
          "post": "</a>"
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var col_div = $(jq('newsearch_collection_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(col_div).next('br').remove();\n" +
                  "  var link = $(col_div).find('a');\n" +
                  "  if (link.length > 0) {\n" +
                  "    var link_text = link.text();\n" +
                  '    link.attr("href", \'?source={"query":{"query_string":{"query":"\\\\"\' + link_text + \'\\\\""}}}\');\n' +
                  "  }else {\n" +
                  "    $(col_div).remove();\n" +
                  "  }\n" +
                  "});<\/script>"
        }
      ],
      [
        {
          "pre": "<b>json:</b><br/>",
          "field": "href",
          "post": ""
        }
      ],
      [
        {
          "pre": '<br/><table><tr><td id="searchbundle_',
          "field": "_id",
          "post": '"><a class="btn btn-info">Search Bundles</a>'
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 '  var id = "', 
          "field": "_id",
          "post": '";\n' +
                 "  var link = $(jq('searchbundle_' + id + ' a'));\n",
        },
        {
          "pre": '  var type = "',
          "field": "_type",
          "post": '";\n' +
                  //'  if (type == "bundle") {\n' +
                  '  if (true) {\n' +
                  "    $(jq('searchbundle_' + id)).remove();\n" +
                  "  }else {\n" +
                  '    link.attr("href", \'?source={"query":{"bool":{"must":[{"term":{"_type":"bundle"}},{"query_string":{"query":"\\\\"\' + id + \'\\\\""}}]}}}\');\n' +
                  //'    link.attr("href", "search_bundle?id=" + id);\n' +
                  "  }\n" +
                  "});<\/script></td>"
        },
        {
          "pre": '<td><a class="btn btn-primary" id="provesjson_',
          "field": "_id",
          "post": '">JSON</a>'
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var link = $(jq('provesjson_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(link).on('click', show_prov_es_json);\n" +
                  "});<\/script></td>"
        },
        {
          "pre": '<td><a class="btn btn-inverse" id="provesttl_',
          "field": "_id",
          "post": '">Turtle</a>'
        },
        {
          "pre": "</div><script>$(function() {\n" +
                 "  var link = $(jq('provesttl_",
          "field": "_id",
          "post": "'));\n" +
                  "  $(link).on('click', show_prov_es_ttl);\n" +
                  "});<\/script></td>"
        },
        {
          "pre": '<td><a class="btn btn-success" id="fdl_lineage_',
          "field": "_id",
          "post": '"'
        },
        {
          "pre": " href=\"{{ url_for('.fdl') }}?id=",
          "field": "_id",
          "post": '" target="_blank">Lineage Graph</a></td></tr></table>'
        }
      ]
    ]
  });

  // init range_slider_start
  /*
  $( "#range_slider_starttime" ).dateRangeSlider({
    bounds: {
      min: new Date(2000, 0, 1),
      max: new Date()
    },
    defaultValues: {
      min: new Date(2000, 0, 1),
      max: new Date()
    } 
  }); 
  */

  // set tablecloth
  var rules_table = $('#rules_table').tablecloth({
    theme: "stats",
    striped: true,
    condensed: true
  });

  // validate form
  var validator = $( '#rule_form' ).validate({
    rules: {
      rule_name: {
        required: true
      },
      query_string: {
        required: true
      },
      workflow: {
        minlength: 1,
        required: true
      }
    },
    messages: {
      rule_name: "Please specify a name for this rule.",
      workflow: "Please select an action."
    }
  });

  // validate procthis form
  var procthis_validator = $( '#procthis_form' ).validate({
    rules: {
      procthis_name: {
        required: true
      },
      query_string: {
        required: true
      },
      workflow: {
        minlength: 1,
        required: true
      }
    },
    messages: {
      procthis_name: "Please specify a name for this job.",
      workflow: "Please select an action."
    }
  });

  // show rules modal
  $('#my_rules').on('click', function() {
    $.ajax({
      url: "user_rules/list",
      success: function(data, sts, xhr) {
        //console.log(data);
        $('#general_error').html("");

        // clear table
        var tbody = $('#rules_table > tbody'); 
        tbody.empty();

        // populate table
        for (var i=0; i < data.rules.length; i++) {
          var status_cell = "<td><button class='btn btn-mini btn-danger toggle_rule' type='button' value='" +
                            data.rules[i]['id'] + "'>Off</button></td>";
          if (data.rules[i]['enabled'])
            status_cell = "<td><button class='btn btn-mini btn-success toggle_rule' type='button' value='" +
                          data.rules[i]['id'] + "'>On</button></td>";
          tbody.append("<tr id='rule_" + data.rules[i]['id'] + "'>" +
                       "<td>" + data.rules[i]['rule_name'] + "</td>" +
                       "<td>" + data.rules[i]['query_string'] + "</td>" +
                       "<td>" + data.rules[i]['workflow'] + "</td>" +
                       "<td>" + data.rules[i]['kwargs'] + "</td>" +
                       status_cell +
                       "<td><button class='btn btn-mini btn-primary edit_rule' type='button' value='" + 
                       data.rules[i]['id'] + "'>Edit</button></td>" +
                       "<td><button class='btn btn-mini btn-warning remove_rule' type='button' value='" + 
                       data.rules[i]['id'] + "' rule_name='" + data.rules[i]['rule_name'] + 
                       "'>Delete</button></td></tr>");
        }

        // append handlers to status buttons
        $('button.toggle_rule').on('click', function() {
          var button = $(this);
          var rule_id = button.attr('value');
          var cur_status = button.text();
          if (cur_status == "Off") {
            var new_status_text = "On";
            var new_status = "true";
            var remove_class = "btn-danger";
            var add_class = "btn-success";
          }else {
            var new_status_text = "Off";
            var new_status = "false";
            var remove_class = "btn-success";
            var add_class = "btn-danger";
          }
          $.ajax({
            type: "POST",
            url: "user_rules/toggle_status",
            data: {
              id: rule_id,
              enabled: new_status
            },
            success: function(data, sts, xhr) {
              button.toggleClass(remove_class + " " + add_class).text(new_status_text);
            },
            error: function(xhr, sts, err) {
              $('#general_error').html("Error: " + xhr.responseText);
              $('#error_modal').modal('show').css({'left': set_left_margin});
            }
          });
        });

        // append handlers to delete buttons
        $('button.remove_rule').on('click', function() {
          var rule_id = $(this).attr('value');
          var rule_name = $(this).attr('rule_name');
          $('#delete_rule_name').text(rule_name);
          $('#delete_rule_id').val(rule_id);
          $('#confirm_delete_modal').modal('show').css({'left': set_left_margin});
        });

        // append handlers to edit buttons
        $('button.edit_rule').on('click', function() {
          var parent_tr = $(this).closest('tr');
          var rule_id = $(this).attr('value');
          $('#rule_id').val(rule_id);
          $('#rule_name').val(parent_tr.children().eq(0).text());
          $('#query_string').val(parent_tr.children().eq(1).text());
          $('#workflow_val').val(parent_tr.children().eq(2).text());
          $('#kwargs').val(parent_tr.children().eq(3).text());
          $('#rule_modal_label').text("Edit Rule");
          $('#rule_modal').modal('show').css({'left': set_left_margin});
          $('#list_rules_modal').modal('hide');
        });

        // show modal
        $('#list_rules_modal').modal('show').css({'left': set_left_margin});
      },
      error: function(xhr, sts, err) {
        //console.log(xhr);
        $('#general_error').html("Error: " + xhr.responseText);
        $('#error_modal').modal('show').css({'left': set_left_margin});
      }
    });
    return false;
  });

  // handler for confirm_delete_btn
  $('#confirm_delete_btn').on('click', function() {
    var rule_id = $('#delete_rule_id').val();
    $.ajax({
      type: "POST",
      url: "user_rules/remove",
      data: {
        id: rule_id
      },
      success: function(data, sts, xhr) {
        $('#rule_' + rule_id).remove();
        $('#confirm_delete_modal').modal('hide');
        $('#general_error').html("");
      },
      error: function(xhr, sts, err) {
        $('#confirm_delete_modal').modal('hide');
        $('#general_error').html("Error: " + xhr.responseText);
        $('#error_modal').modal('show').css({'left': set_left_margin});
      }
    });
  });

  // handler for rule_modal
  $('#rule_modal').on('show', function() {
    $('#ajax_error').html("");
    var rule_id = $('#rule_id').val();

    // check if we're in add mode
    if (rule_id === "") {
      var edit_mode = false;
      var cur_kwargs = {};

      // reset everything
      $('#dynamic_fields').empty();
      validator.resetForm();

      // populate query_string
      var query_json = JSON.stringify(JSON.parse(QUERY_STRING).query, null, '  ');
      $('#query_string').val(query_json);
      //$('#query_string').val(query_json).attr('disabled', true);
    }else {
      var edit_mode = true;
      var cur_kwargs = JSON.parse($('#kwargs').val());
    }
    //console.log("workflow_val: " + $('#workflow_val').val());
    //console.log("kwargs: " + $('#kwargs').val());

    // get actions config
    $.ajax({
      url: "user_rules/actions_config",
      success: function(data, sts, xhr) {
        //console.log(data);
        // populate workflow/action select options
        var workflow = $('#workflow');
        workflow.empty();
        workflow.append("<option value=''></option");
        var actions_cfg = {};
        for (var i=0; i < data.actions.length; i++) {
          actions_cfg[data.actions[i].type] = data.actions[i];
          var disabled = data.actions[i].public ? ">" : "disabled>";
          workflow.append("<option value='" + data.actions[i].type + "' " +
                          disabled + data.actions[i].label + "</option>");
        }

        // add handler to build dynamic form on selected option
        workflow.change(function() {
          // build dynamic form
          var workflow_type = $(this).val();
          var dyn_fields = $('#dynamic_fields');
          dyn_fields.empty();
          var kwargs = actions_cfg[workflow_type].kwargs;
          for (var i=0; i < kwargs.length; i++) {
            var kwarg = kwargs[i];
            if (kwarg.type == "textbox") {
              dyn_fields.append("<div class='control-group'>" +
                                "<label class='control-label' for='" + 
                                kwarg.name + "'>" + kwarg.name + "</label>" +
                                "<div class='controls'>" +
                                "<input class='field span4' type='text' name='" + kwarg.name +
                                "' placeholder='" + kwarg.placeholder + "'></div></div>");
              $('#rule_form input[name=' + kwarg.name + ']').rules("add", kwarg.validator);
              if (kwarg.name in cur_kwargs)
                $('#dynamic_fields input[name=' + kwarg.name + ']').val(cur_kwargs[kwarg.name]);
            }else if (kwarg.type == "textarea") {
              dyn_fields.append("<div class='control-group'>" +
                                "<label class='control-label' for='" + 
                                kwarg.name + "'>" + kwarg.name + "</label>" +
                                "<div class='controls'>" +
                                "<textarea class='field span4' type='textarea' rows='5' name='" + kwarg.name +
                                "' placeholder='" + kwarg.placeholder + "'></textarea></div></div>");
              $('#rule_form textarea[name=' + kwarg.name + ']').rules("add", kwarg.validator);
              if (kwarg.name in cur_kwargs)
                $('#dynamic_fields textarea[name=' + kwarg.name + ']').val(cur_kwargs[kwarg.name]);
            }else {
            }
          }
        });

        // select the current workflow
        if (edit_mode) $('#workflow').val($('#workflow_val').val()).change();
      },
      error: function(xhr, sts, err) {
        //console.log(xhr.responseData);
        $('#general_error').html("Error: " + xhr.responseText);
        $('#error_modal').modal('show').css({'left': set_left_margin});
      }
    });
  });

  $('#rule_modal').on('hide', function() {
    $('#rule_id').val("");
    $('#workflow_val').val("");
    $('#kwargs').val("");
  });

  // handler for rule button
  $('#rule_btn').on('click', function() {
    var rule_id = $('#rule_id').val();

    // check if we're in add mode
    if (rule_id === "") var edit_mode = false;
    else var edit_mode = true;

    if ($('#rule_form').valid()) {
      //console.log("workflow: " + $('#workflow').val());
      //console.log("rule_name: " + $('#rule_name').val());
      //console.log("query_string: " + $('#query_string').val());
      df_fields = {};
      $.each($('#dynamic_fields').find('.field'), function(idx, value) {
        var dyn_input = $(value);
        df_fields[dyn_input.attr('name')] = dyn_input.val();
      });

      if (edit_mode) {
        var rule_data = {
          id: rule_id,
          rule_name: $('#rule_name').val(),
          workflow: $('#workflow').val(),
          query_string: $('#query_string').val(),
          kwargs: JSON.stringify(df_fields, null, '  ')
        };
        var update_url = "user_rules/edit";
      }else {
        var rule_data = {
          rule_name: $('#rule_name').val(),
          workflow: $('#workflow').val(),
          query_string: $('#query_string').val(),
          kwargs: JSON.stringify(df_fields, null, '  ')
        };
        var update_url = "user_rules/add";
      }
      $.ajax({
        type: "POST",
        url: update_url,
        data: rule_data,
        success: function(data, sts, xhr) {
          //console.log(data);
          $('#ajax_error').html("");
          $('#rule_modal').modal('hide');
        },
        error: function(xhr, sts, err) {
          //console.log(xhr);
          var resp = JSON.parse(xhr.responseText);
          $('#ajax_error').html("Error: " + resp.message);
        }
      });
    }
  });

  // handler for procthis_modal
  $('#procthis_modal').on('show', function() {
    $('#procthis_ajax_error').html("");

    var cur_kwargs = {};

    // reset everything
    $('#procthis_dynamic_fields').empty();
    procthis_validator.resetForm();

    // populate query_string
    var query_json = JSON.stringify(JSON.parse(QUERY_STRING).query, null, '  ');
    $('#procthis_query_string').val(query_json);
    //$('#procthis_query_string').val(query_json).attr('disabled', true);
    //console.log("workflow_val: " + $('#procthis_workflow_val').val());
    //console.log("kwargs: " + $('#procthis_kwargs').val());

    // get actions config
    $.ajax({
      url: "user_rules/actions_config",
      success: function(data, sts, xhr) {
        //console.log(data);
        // populate workflow/action select options
        var workflow = $('#procthis_workflow');
        workflow.empty();
        workflow.append("<option value=''></option");
        var actions_cfg = {};
        for (var i=0; i < data.actions.length; i++) {
          actions_cfg[data.actions[i].type] = data.actions[i];
          var disabled = data.actions[i].public ? ">" : "disabled>";
          workflow.append("<option value='" + data.actions[i].type + "' " +
                          disabled + data.actions[i].label + "</option>");
        }

        // add handler to build dynamic form on selected option
        workflow.change(function() {
          // build dynamic form
          var workflow_type = $(this).val();
          var dyn_fields = $('#procthis_dynamic_fields');
          dyn_fields.empty();
          var kwargs = actions_cfg[workflow_type].kwargs;
          for (var i=0; i < kwargs.length; i++) {
            var kwarg = kwargs[i];
            if (kwarg.type == "textbox") {
              dyn_fields.append("<div class='control-group'>" +
                                "<label class='control-label' for='" + 
                                kwarg.name + "'>" + kwarg.name + "</label>" +
                                "<div class='controls'>" +
                                "<input class='field span4' type='text' name='" + kwarg.name +
                                "' placeholder='" + kwarg.placeholder + "'></div></div>");
              $('#procthis_form input[name=' + kwarg.name + ']').rules("add", kwarg.validator);
              if (kwarg.name in cur_kwargs)
                $('#procthis_dynamic_fields input[name=' + kwarg.name + ']').val(cur_kwargs[kwarg.name]);
            }else if (kwarg.type == "textarea") {
              dyn_fields.append("<div class='control-group'>" +
                                "<label class='control-label' for='" + 
                                kwarg.name + "'>" + kwarg.name + "</label>" +
                                "<div class='controls'>" +
                                "<textarea class='field span4' type='textarea' rows='5' name='" + kwarg.name +
                                "' placeholder='" + kwarg.placeholder + "'></textarea></div></div>");
              $('#procthis_form textarea[name=' + kwarg.name + ']').rules("add", kwarg.validator);
              if (kwarg.name in cur_kwargs)
                $('#procthis_dynamic_fields textarea[name=' + kwarg.name + ']').val(cur_kwargs[kwarg.name]);
            }else {
            }
          }
        });
      },
      error: function(xhr, sts, err) {
        //console.log(xhr.responseData);
        $('#general_error').html("Error: " + xhr.responseText);
        $('#error_modal').modal('show').css({'left': set_left_margin});
      }
    });
  });

  // handler for procthis button
  $('#procthis_btn').on('click', function() {
    if ($('#procthis_form').valid()) {
      //console.log("workflow: " + $('#procthis_workflow').val());
      //console.log("procthis_name: " + $('#procthis_name').val());
      //console.log("query_string: " + $('#procthis_query_string').val());
      df_fields = {};
      $.each($('#procthis_dynamic_fields').find('.field'), function(idx, value) {
        var dyn_input = $(value);
        df_fields[dyn_input.attr('name')] = dyn_input.val();
      });

      var procthis_data = {
        name: $('#procthis_name').val(),
        workflow: $('#procthis_workflow').val(),
        query_string: $('#procthis_query_string').val(),
        kwargs: JSON.stringify(df_fields, null, '  ')
      };
      var submit_url = "user_rules/submit_job";
      $.ajax({
        type: "POST",
        url: submit_url,
        data: procthis_data,
        success: function(data, sts, xhr) {
          //console.log(data);
          $('#procthis_ajax_error').html("");
          $('#procthis_modal').modal('hide');
        },
        error: function(xhr, sts, err) {
          //console.log(xhr);
          try {
            var resp = JSON.parse(xhr.responseText);
            $('#procthis_ajax_error').html("Error: " + resp.message);
          } catch(jerr) {
            $('#procthis_ajax_error').html("Error: " + err);
          }
        }
      });
    }
  });

  // handler for prov_es_json_modal
  $('#prov_es_json_modal').on('show', function() {
    $('#prov_es_json_modal_download').attr('disabled', false);
  });

  // handler for prov_es_ttl_modal
  $('#prov_es_ttl_modal').on('show', function() {
    $('#prov_es_ttl_modal_download').attr('disabled', false);
  });

  // open up all facets on page load
  $('.facetview_filtershow').each(function(index, value) {
    $(value).click();
  });

  // add force toggle
  $('#toggle_force').on('click', function() {
    if (forceEnabled) {
      forceEnabled = false;
      $(this).removeClass("btn-success");
      setTimeout(function() {
          force.stop();
          setGraphVizLocs();
      }, 100);
    }else {
      forceEnabled = true;
      $(this).addClass("btn-success");
      enableForce();
      setTimeout(function() {
          force.start();
      }, 500);
    }
  });

  // add agent labels toggle
  $('#toggle_agent_labels').on('click', function() {
    if (hideLabel.agent) {
      hideLabel.agent = false;
      $(this).addClass("btn-success");
      if (agentGroup) {
        agentGroup.selectAll("polygon")
          .data(force.nodes().filter(function(d) {
            if (d.prov_type == "agent") {
              showText(d);
              return true;
            }
            return false;
          }))
          .on('mouseover', toggleTip)
          .on('mouseout', toggleTip);
      }
    }else {
      hideLabel.agent = true;
      $(this).removeClass("btn-success");
      if (agentGroup) {
        agentGroup.selectAll("polygon")
          .data(force.nodes().filter(function(d) {
            if (d.prov_type == "agent") {
              hideText(d);
              return true;
            }
            return false;
          }))
          .on('mouseover', toggleTip)
          .on('mouseout', toggleTip);
      }
    }
  });

  // add activity labels toggle
  $('#toggle_activity_labels').on('click', function() {
    if (hideLabel.activity) {
      hideLabel.activity = false;
      $(this).addClass("btn-success");
      if (actsGroup) {
        actsGroup.selectAll("circle")
          .data(force.nodes().filter(function(d) {
            if (d.prov_type == "activity") {
              showText(d);
              return true;
            }
            return false;
          }))
          .on('mouseover', toggleTip)
          .on('mouseout', toggleTip);
      }
    }else {
      hideLabel.activity = true;
      $(this).removeClass("btn-success");
      if (actsGroup) {
        actsGroup.selectAll("circle")
          .data(force.nodes().filter(function(d) {
            if (d.prov_type == "activity") {
              hideText(d);
              return true;
            }
            return false;
          }))
          .on('mouseover', toggleTip)
          .on('mouseout', toggleTip);
      }
    }
  });

  // add entity labels toggle
  $('#toggle_entity_labels').on('click', function() {
    if (hideLabel.entity) {
      hideLabel.entity = false;
      $(this).addClass("btn-success");
      if (entsGroup) {
        entsGroup.selectAll("rect")
          .data(force.nodes().filter(function(d) {
            if (d.prov_type == "entity") {
              showText(d);
              return true;
            }
            return false;
          }))
          .on('mouseover', toggleTip)
          .on('mouseout', toggleTip);
      }
    }else {
      hideLabel.entity = true;
      $(this).removeClass("btn-success");
      if (entsGroup) {
        entsGroup.selectAll("rect")
          .data(force.nodes().filter(function(d) {
            if (d.prov_type == "entity") {
              hideText(d);
              return true;
            }
            return false;
          }))
          .on('mouseover', toggleTip)
          .on('mouseout', toggleTip);
      }
    }
  });

  // add path labels toggle
  $('#toggle_path_labels').on('click', function() {
    if (hideLabel.path) {
      hideLabel.path = false;
      $(this).addClass("btn-success");
      if (pathGroup) {
        pathGroup.selectAll("path")
          .data(force.links().filter(function(d) {
            if (d.concept !== undefined) {
              showPathText(d);
              return true;
            }
            return false;
          }))
          .on('mouseover', toggleTip)
          .on('mouseout', toggleTip);
      }
    }else {
      hideLabel.path = true;
      $(this).removeClass("btn-success");
      if (pathGroup) {
        pathGroup.selectAll("path")
          .data(force.links().filter(function(d) {
            if (d.concept !== undefined) {
              hidePathText(d);
              return true;
            }
            return false;
          }))
          .on('mouseover', toggleTip)
          .on('mouseout', toggleTip);
      }
    }
  });
});
  </script>
</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">
      <a class="brand" href="#">PROV-ES Facet Search</a>
      <ul class="nav">
        <li><a href="{{ url_for('.home') }}">Home</a></li>
        <li><a href="{{ url_for('api_v0-1.doc') }}">API</a></li>
      </ul>
      <button class="btn" id="toggle_force">Force</button>
      <button class="btn" id="toggle_agent_labels">Agent Labels</button>
      <button class="btn" id="toggle_activity_labels">Activity Labels</button>
      <button class="btn" id="toggle_entity_labels">Entity Labels</button>
      <button class="btn" id="toggle_path_labels">Property Labels</button>
    </div>
  </div>
</div>

    <!--Alerts-->
    {% with messages = get_flashed_messages() %}
    {% if messages %}
      {% for message in messages %}
      <div class="container"> 
        <div class="alert alert-success">
          <a href="#" class="close" data-dismiss="alert">&times;</a>
          {{ message }}
        </div>
      </div>
      {% endfor %}
      <script>
        window.setTimeout( function() {
          $( ".alert" ).fadeTo(500, 0).slideUp(500, function() {
            $(this).remove();
          });
        }, 5000);
      </script>
    {% endif %}
    {% endwith %}

<div class="container"> 
  <div class="content">
    <div class="page-header">
      <h1>
        PROV-ES Facet Search <small>faceted search interface for earth science provenance</small>
      </h1>
    </div>

    <!--<h4>GRQ facets</h4>-->
    <div class="facet-view-simple"></div>

    <!-- create rule modal -->
    <div id="rule_modal" class="modal hide fade" tabindex="-1" role="dialog"
         aria-labelledby="rule_modal_label" aria-hidden="true" data-backdrop="static"
         data-keyboard="false">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="rule_modal_label">Monitor This</h3>
      </div>
      <div class="modal-body">
        <div class="modal-body-div">
          <form id="rule_form" class="form-horizontal">
            <input type="hidden" id="rule_id"/>
            <input type="hidden" id="workflow_val"/>
            <input type="hidden" id="kwargs"/>
            <div class="control-group">
              <label class="control-label" for="rule_name">Rule name</label>
              <div class="controls">
                <input class="field span4" type="text" id="rule_name" name="rule_name" placeholder="e.g. Email Calimap">
              </div>
            </div>
            <div class="control-group">
              <label class="control-label" for="query_string">Condition</label>
              <div class="controls">
                <textarea class="field span4" type="textarea" rows="5" id="query_string" name="query_string"></textarea>
              </div>
            </div>
            <div class="control-group">
              <label class="control-label" for="workflow">Action</label>
              <div class="controls">
                <select class="field span4" name="workflow" id="workflow"></select>
              </div>
            </div>
            <fieldset id="dynamic_fields" />
          </form>
        </div>
        <div>
          <label id="ajax_error" class="error" style="display: block;"></label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn cancel_rule" data-dismiss="modal" aria-hidden="true">Cancel</button>
        <button id="rule_btn" class="btn btn-primary">OK</button>
      </div>
    </div>

    <!-- process this modal -->
    <div id="procthis_modal" class="modal hide fade" tabindex="-1" role="dialog"
         aria-labelledby="procthis_modal_label" aria-hidden="true" data-backdrop="static"
         data-keyboard="false">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="procthis_modal_label">Monitor This</h3>
      </div>
      <div class="modal-body">
        <div class="modal-body-div">
          <form id="procthis_form" class="form-horizontal">
            <input type="hidden" id="procthis_workflow_val"/>
            <input type="hidden" id="procthis_kwargs"/>
            <div class="control-group">
              <label class="control-label" for="procthis_name">Rule name</label>
              <div class="controls">
                <input class="field span4" type="text" id="procthis_name" name="procthis_name" placeholder="e.g. Email Calimap">
              </div>
            </div>
            <div class="control-group">
              <label class="control-label" for="query_string">Condition</label>
              <div class="controls">
                <textarea class="field span4" type="textarea" rows="5" id="procthis_query_string" name="query_string"></textarea>
              </div>
            </div>
            <div class="control-group">
              <label class="control-label" for="workflow">Action</label>
              <div class="controls">
                <select class="field span4" name="workflow" id="procthis_workflow"></select>
              </div>
            </div>
            <fieldset id="procthis_dynamic_fields" />
          </form>
        </div>
        <div>
          <label id="procthis_ajax_error" class="error" style="display: block;"></label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn cancel_rule" data-dismiss="modal" aria-hidden="true">Cancel</button>
        <button id="procthis_btn" class="btn btn-primary">Process Now</button>
      </div>
    </div>

    <!-- list my rules modal -->
    <div id="list_rules_modal" class="modal hide fade list_rules_modal" tabindex="-1" role="dialog"
         aria-labelledby="list_rules_modal_label" aria-hidden="true" data-backdrop="static"
         data-keyboard="false">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="list_rules_modal_label">My Rules</h3>
      </div>
      <div class="modal-body">
        <div class="modal-body-div">
          <table id="rules_table" cellspacing="1" cellpadding="3" class="tablehead" style="background:#CCC;">
            <caption>
              These are the rules you have defined.
            </caption>
            <thead>
              <tr class="colhead">
                <th>Name</th>
                <th>Condition</th>
                <th>Action</th>
                <th>Keyword Args</th>
                <th class="{sorter: false}">Status</th>
                <th class="{sorter: false}">Edit</th>
                <th class="{sorter: false}">Delete</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn close_list_rules" data-dismiss="modal" aria-hidden="true">Close</button>
      </div>
    </div>

    <!-- confirm deletion modal -->
    <div id="confirm_delete_modal" class="modal hide fade" tabindex="-1" role="dialog"
         aria-labelledby="confirm_delete_modal_label" aria-hidden="true" data-backdrop="static"
         data-keyboard="false">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="confirm_delete_modal_label">Delete Confirmation</h3>
      </div>
      <div class="modal-body">
        <div class="modal-body-div">
          <p>Are you sure you want to delete the rule named "<b id="delete_rule_name"></b>"?</p>
          <input type="hidden" id="delete_rule_id"/>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn cancel_confirm_delete" data-dismiss="modal" aria-hidden="true">No</button>
        <button id="confirm_delete_btn" class="btn btn-primary confirm_delete">Yes</button>
      </div>
    </div>

    <!-- error message modal -->
    <div id="error_modal" class="modal hide fade error_modal" tabindex="-1" role="dialog"
         aria-labelledby="error_modal_label" aria-hidden="true" data-backdrop="static"
         data-keyboard="false">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="error_modal_label">Encountered Error</h3>
      </div>
      <div class="modal-body">
        <div class="modal-body-div"><label id="general_error" class="error" style="display: block;"></label></div>
      </div>
      <div class="modal-footer">
        <button class="btn close_error" data-dismiss="modal" aria-hidden="true">Close</button>
      </div>
    </div>

    <!-- prov_es_json modal -->
    <div id="prov_es_json_modal" class="modal hide fade prov_es_json_modal" tabindex="-1" role="dialog"
         aria-labelledby="prov_es_json_modal_label" aria-hidden="true" data-backdrop="static"
         data-keyboard="false">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="prov_es_json_modal_label">PROV-ES JSON</h3>
      </div>
      <div class="modal-body">
        <div class="modal-body-div"><label id="prov_es_json_text" style="display: block;"></label></div>
      </div>
      <div class="modal-footer">
        <a class="btn btn-success" target="_blank" id="prov_es_json_modal_download" href="">Download</a>
        <button class="btn close_error" data-dismiss="modal" aria-hidden="true">Close</button>
      </div>
    </div>

    <!-- prov_es_ttl modal -->
    <div id="prov_es_ttl_modal" class="modal hide fade prov_es_ttl_modal" tabindex="-1" role="dialog"
         aria-labelledby="prov_es_ttl_modal_label" aria-hidden="true" data-backdrop="static"
         data-keyboard="false">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h3 id="prov_es_ttl_modal_label">PROV-ES Turtle</h3>
      </div>
      <div class="modal-body">
        <div class="modal-body-div"><label id="prov_es_ttl_text" style="display: block;"></label></div>
      </div>
      <div class="modal-footer">
        <a class="btn btn-success" target="_blank" id="prov_es_ttl_modal_download" href="">Download</a>
        <button class="btn close_error" data-dismiss="modal" aria-hidden="true">Close</button>
      </div>
    </div>

  </div>

</div>
</body>
</html>
